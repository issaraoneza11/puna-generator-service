pipeline {
  agent { label "node-ttt-x.x.184.66" }

  parameters {
    string(
      name: 'RELEASE_BRANCH',
      defaultValue: 'v1.0.0',
      description: 'Release branch to checkout and build'
    )
  }

  environment {
    APP_NAME       = 'tiffa-ultimate-report-service'
    IMAGE_TAG      = "release-${params.RELEASE_BRANCH}"
    DOCKER_IMAGE   = "${APP_NAME}:${IMAGE_TAG}"
    DOCKER_HUB_REPO = "cmtttbrother/${APP_NAME}"
  }

  stages {
    stage('Checkout & Env') {
      steps {
        cleanWs()
        
        // Checkout code à¸•à¸²à¸¡ branch release input
        checkout([
          $class: 'GitSCM',
          branches: [[name: "*/release/${params.RELEASE_BRANCH}"]],
          userRemoteConfigs: scm.userRemoteConfigs
        ])

        // à¸ªà¸£à¹‰à¸²à¸‡à¹„à¸Ÿà¸¥à¹Œ .env à¸ˆà¸²à¸ /cicd/release/.env.release (à¹€à¸‚à¸µà¸¢à¸™à¸—à¸±à¸šà¹€à¸”à¸´à¸¡)
        sh '''
          if [ -f cicd/release/.env.release ]; then
            echo "à¹€à¸‚à¸µà¸¢à¸™à¸—à¸±à¸š .env à¸”à¹‰à¸§à¸¢ cicd/release/.env.release"
            cp cicd/release/.env.release .env
            echo "âœ… .env file created successfully"
          else
            echo "âŒ à¹„à¸¡à¹ˆà¸žà¸š cicd/release/.env.release" && exit 1
          fi
          echo "à¹ƒà¸Šà¹‰ .env:"
          cat .env | sed 's/=.*/=***/'
          echo "ðŸ“ Files in current directory:"
          ls -la | grep -E "\\.env"
        '''
      }
    }

    stage('Build Image') {
      steps {
        sh """
          docker build -t ${DOCKER_IMAGE} .
          docker tag ${DOCKER_IMAGE} ${DOCKER_HUB_REPO}:${IMAGE_TAG}
          docker tag ${DOCKER_IMAGE} ${DOCKER_HUB_REPO}:release-latest
          docker images | grep ${APP_NAME} || true
        """
      }
    }

    stage('Push to Docker Hub') {
      steps {
        script {
          withCredentials([usernamePassword(credentialsId: 'docker-hub-credentials', usernameVariable: 'DOCKER_USERNAME', passwordVariable: 'DOCKER_PASSWORD')]) {
            sh """
              echo "Login to Docker Hub..."
              echo \$DOCKER_PASSWORD | docker login -u \$DOCKER_USERNAME --password-stdin
              
              echo "Push images to Docker Hub..."
              docker push ${DOCKER_HUB_REPO}:${IMAGE_TAG}
              docker push ${DOCKER_HUB_REPO}:release-latest
              
              echo "Logout from Docker Hub..."
              docker logout
            """
          }
        }
      }
    }

    // (à¸—à¸²à¸‡à¹€à¸¥à¸·à¸­à¸) Cleanup à¹à¸šà¸šà¸›à¸¥à¸­à¸”à¸ à¸±à¸¢: à¸—à¸³à¹€à¸¡à¸·à¹ˆà¸­à¸”à¸´à¸ªà¸à¹Œà¹€à¸à¸´à¸™ 85% à¹€à¸—à¹ˆà¸²à¸™à¸±à¹‰à¸™
    stage('Optional Cleanup') {
      when {
        expression {
          // à¹ƒà¸Šà¹‰à¹€à¸›à¸­à¸£à¹Œà¹€à¸‹à¹‡à¸™à¸•à¹Œà¸”à¸´à¸ªà¸à¹Œà¸£à¸¹à¸—
          def use = sh(script: "df -h / | awk 'NR==2{print int(\$5)}'", returnStdout: true).trim()
          return use.isInteger() && use.toInteger() > 85
        }
      }
      steps {
        // à¹„à¸¡à¹ˆà¹ƒà¸Šà¹‰ --all/--volumes à¹€à¸žà¸·à¹ˆà¸­à¹„à¸¡à¹ˆà¸žà¸±à¸‡ cache à¹€à¸¥à¹€à¸¢à¸­à¸£à¹Œ
        sh 'docker system prune -f || true'
      }
    }
  }

  post {
    always {
      sh 'docker system prune --all --volumes -f'
    }
    success { echo 'ðŸŽ‰ Release build and push success' }
    failure { echo 'ðŸ’¥ Release build and push failed' }
  }
}